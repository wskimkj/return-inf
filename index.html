<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>발주서</title>

<link rel="icon" type="image/png" href="android-icon-48x48.ico" />
<link rel="stylesheet" as="style" crossorigin
  href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --page-bg: #f7f4ff;
  --page-bg2:#eef6ff;

  --card-bg: rgba(255,255,255,.86);
  --card-stroke: rgba(170,150,230,.22);

  --text: #2f2a3a;
  --sub: #6e6a82;
  --muted: #9a96ad;

  --pink: #ff8fbc;
  --pink2:#ffd2e3;
  --lilac:#b8a7ff;

  --shadow-main: 0 18px 50px rgba(30, 18, 60, .10);
  --shadow-card: 0 10px 26px rgba(30, 18, 60, .08);
  --shadow-soft: 0 6px 18px rgba(30, 18, 60, .06);
}

*{box-sizing:border-box;font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
html,body{height:100%;}

body{
  margin:0;
  font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--text-main);
  background:
    radial-gradient(900px 520px at 20% 18%, rgba(255,143,188,.25), transparent 60%),
    radial-gradient(900px 520px at 82% 24%, rgba(184,167,255,.20), transparent 58%),
    linear-gradient(180deg, var(--page-bg), var(--page-bg2));
}

  .inner-shell{
  background: rgba(255,255,255,.9);
  border: 1px solid rgba(170,150,230,.22);
  box-shadow:
    0 18px 50px rgba(30,18,60,.10),
    inset 0 1px 0 rgba(255,255,255,.6);
}

  
.container{
  max-width: 1280px;
  margin: 0 auto;
  padding: 34px 18px 44px;
}

.glow{
  position:fixed;
  inset:-20%;
  pointer-events:none;
  filter: blur(70px);
  opacity:.10;
  z-index:0;
}
.glow::before,
.glow::after{
  content:"";
  position:absolute;
  width:620px;height:620px;border-radius:50%;
  left:10%; top:10%;
  background: radial-gradient(circle at 30% 30%, rgba(255,143,188,.55), transparent 60%);
}
.glow::after{
  width:680px;height:680px;
  right:8%; top:12%;
  left:auto;
  background: radial-gradient(circle at 30% 30%, rgba(184,167,255,.50), transparent 62%);
}

/* card */
.card{
  position:relative;
  z-index:1;
  background: var(--card-bg);
  border: 1px solid var(--card-stroke);
  border-radius: 22px;
  box-shadow: var(--shadow-main);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  overflow:hidden;
}
.card::before{
  content:"";
  position:absolute; inset:-2px;
  background:
    radial-gradient(900px 260px at 8% 0%, rgba(255,143,188,.18), transparent 60%),
    radial-gradient(900px 260px at 92% 0%, rgba(184,167,255,.14), transparent 55%);
  pointer-events:none;
  opacity:.85;
}
.card-inner{position:relative;padding: 18px 18px 14px;}

/* Neon Glass pill (클릭 가능) */
.pill{
  font-size:11px;
  padding:4px 10px;
  border-radius:999px;
  background: linear-gradient(90deg, rgba(255,143,188,.22), rgba(184,167,255,.18));
  border:1px solid rgba(170,150,230,.25);
  color: rgba(47,42,58,.80);
  box-shadow: 0 1px 0 rgba(255,255,255,.55) inset;
}
a.pill{
  text-decoration:none;
  display:inline-flex;
  align-items:center;
}
a.pill:hover{
  border-color: rgba(255,143,188,.55);
  box-shadow: 0 0 0 3px rgba(255,143,188,.14), 0 1px 0 rgba(255,255,255,.55) inset;
}

/* ===== Card Header ===== */
.card-header{ margin-bottom: 12px; }

.card-title{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:18px;
  font-weight:800;
  letter-spacing:-.2px;
  color: var(--text);
}
.card-title .pill{ margin-left:6px; }

.header-meta{
  margin-top:8px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  font-size:12px;
  color: rgba(110,106,130,.80);
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  background: rgba(255,255,255,.55);
  border:1px solid rgba(170,150,230,.18);
  box-shadow: var(--shadow-soft);
}

.dot{
  width:7px;height:7px;border-radius:50%;
  background: rgba(154,150,173,.35);
  box-shadow: 0 0 0 1px rgba(154,150,173,.20) inset;
}
.dot.live{
  background: var(--pink);
  box-shadow: 0 0 0 3px rgba(255,143,188,.20);
}

/* ===================== SEARCH UI ===================== */
.search-row{
  display:flex;
  gap:12px;
  align-items:center;
  margin: 10px 0 12px;
}
.search{
  flex:1;
  position:relative;
  display:flex;
  align-items:center;
  gap:8px;
  padding: 8px 44px 8px 12px;
  border-radius: 14px;
  background: rgba(243,241,250,.82);
  border: 1px solid rgba(170,150,230,.20);
  box-shadow: var(--shadow-soft);
}
.search:focus-within{
  border-color: rgba(255,143,188,.55);
  box-shadow: 0 0 0 3px rgba(255,143,188,.16), var(--shadow-soft);
}

.search-icon{
  width:16px;
  height:16px;
  flex:0 0 auto;
  opacity:.60;
}
.search-icon path{
  stroke: rgba(47,42,58,.65);
  stroke-width: 2;
  fill: none;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.search input{
  width:100%;
  border:0;
  outline:0;
  background:transparent;
  color:var(--text);
  font-size:12.5px;
  line-height: 1.1;
  padding: 0;
}
.search input::placeholder{ color: rgba(110,106,130,.55); }

.enter-hint{
  position:absolute;
  right:12px;
  top:50%;
  transform: translateY(-50%);
  font-size:11px;
  color: rgba(110,106,130,.60);
  user-select:none;
  pointer-events:none;
}

/* table */
.table-wrap{
  border-radius:16px;
  border: 1px solid rgba(170,150,230,.18);
  overflow:auto;
  background: rgba(255,255,255,.65);
  box-shadow: 0 1px 0 rgba(255,255,255,.70) inset;
  max-height: 560px;
}

table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  font-size:12px;
}

thead th{
  position: sticky;
  top:0;
  z-index:2;
  text-align:left;
  padding:10px 12px;
  background: rgba(255,255,255,.78);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(170,150,230,.18);
  color: rgba(47,42,58,.88);
  font-weight:700;
  user-select:none;
  cursor:pointer;
}
thead th:first-child{border-top-left-radius:16px; cursor:default;}
thead th:last-child{border-top-right-radius:16px;}

tbody td{
  padding:10px 12px;
  border-bottom:1px solid rgba(170,150,230,.12);
  color: rgba(47,42,58,.86);
}

tbody tr{background: rgba(255,255,255,.48);}
tbody tr:nth-child(even){background: rgba(243,241,250,.55);}
tbody tr:hover{
  background: linear-gradient(90deg, rgba(255,143,188,.22), rgba(184,167,255,.16));
}

.copy{cursor:pointer;}
.copy:active{transform: translateY(0.5px);}

.sort-ind{display:inline-flex;align-items:center;gap:6px;}
.sort-dot{
  width:6px;height:6px;border-radius:50%;
  background: rgba(154,150,173,.40);
  box-shadow: 0 0 0 1px rgba(154,150,173,.18) inset;
}
.sort-dot.on{
  background: var(--pink);
  box-shadow: 0 0 0 3px rgba(255,143,188,.18);
}
.arrow{
  font-size:11px;
  opacity:.9;
  color: rgba(255,143,188,.95);
}

.no-data{
  padding:22px 14px;
  text-align:center;
  color: rgba(110,106,130,.70);
  font-size:12px;
}

/* toast */
#toast{
  position:fixed;
  right:18px;
  bottom:18px;
  z-index:9999;
  padding:10px 12px;
  border-radius:14px;
  background: rgba(255,255,255,.88);
  border:1px solid rgba(255,143,188,.35);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: rgba(47,42,58,.92);
  box-shadow: 0 18px 50px rgba(30, 18, 60, .12);
  opacity:0;
  transform: translateY(10px);
  transition: .18s ease;
  pointer-events:none;
}
#toast.show{opacity:1;transform: translateY(0);}

/* ===== 드래그 선택 하이라이트 ===== */
td.sel{
  background: rgba(255, 245, 140, .45) !important;
}

@media (max-width: 760px){
  .table-wrap{max-height: 68vh;}
  .search{ padding-right: 38px; }
  .enter-hint{ right: 10px; }
}
</style>
</head>

<body>
<div class="glow"></div>

<div class="container">
  <div class="card">
    <div class="card-inner">

      <div class="card-header">
        <div class="card-title">
          <span class="title-text">Information</span>
          <a class="pill" id="dbLink" href="#" target="_blank" rel="noopener noreferrer">DB 이동</a>
        </div>

        <!-- ✅ JS가 쓰는 id들 복구 -->
        <div class="header-meta">
          <span class="badge"><span class="dot live"></span><span id="loadStatus">DB 로딩 중...</span></span>
          <span class="badge"><strong id="resultCount"></strong></span>
          <span class="badge" id="cacheHint" style="display:none;"></span>
        </div>
      </div>

      <div class="search-row">
        <div class="search">
          <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M11 19a8 8 0 1 1 0-16a8 8 0 0 1 0 16Z"></path>
            <path d="M21 21l-4.35-4.35"></path>
          </svg>
          <input id="searchInput" type="text" placeholder="주문번호, 수령인, 상품명…" />
          <span class="enter-hint">Enter ↵</span>
        </div>
      </div>

      <div class="table-wrap" id="tableWrapper">
        <div class="no-data">데이터 로딩 중…</div>
      </div>

    </div>
  </div>
</div>

<div id="toast">복사됨</div>

<script>
/* ===================== ✅ Config ===================== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/export?format=csv&gid=518656308";

/* ✅ 여기에 네 진짜 DB 이동 링크 넣어 */
const DB_SHEET_LINK = "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/edit#gid=518656308";

document.getElementById("dbLink").href = DB_SHEET_LINK;

const COL = {
  ORDER_NO: 1, MALL: 2, RECEIVER: 3, INVOICE: 5, PHONE: 6,
  PRODUCT: 10, QTY: 11, AMOUNT: 12, COLOR: 18
};

let dataRows = [];
let sortState = { key: null, dir: 1 };

/* ===================== Cache (Local) ===================== */
const CACHE_KEY = "order_csv_cache_v2";
const CACHE_TIME_KEY = "order_csv_cache_time_v2";
const CACHE_TTL_MS = 1000 * 60 * 60 * 6; // 6h

async function fetchWithTimeout(url, timeoutMs = 8000){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);
  try{
    const res = await fetch(url, { signal: controller.signal });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  } finally {
    clearTimeout(t);
  }
}

function saveCache(csvText){
  try{
    localStorage.setItem(CACHE_KEY, csvText);
    localStorage.setItem(CACHE_TIME_KEY, String(Date.now()));
  }catch(e){
    console.warn("캐시 저장 실패:", e);
  }
}
function readCache(){
  const csvText = localStorage.getItem(CACHE_KEY);
  const ts = Number(localStorage.getItem(CACHE_TIME_KEY) || 0);
  if(!csvText) return null;
  return { csvText, ts };
}
function isCacheFresh(ts){ return (Date.now() - ts) <= CACHE_TTL_MS; }

/* ===================== UI Helpers ===================== */
const $ = (id)=>document.getElementById(id);

function debounce(fn, wait=180){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
}

function showToast(msg="복사됨"){
  const el = $("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 850);
}

function toNumber(v){
  const n = String(v ?? "").replace(/[^0-9.-]/g,"");
  return Number(n) || 0;
}

function setHeaderStatus(text){
  const el = $("loadStatus");
  if(el) el.textContent = text;
}

function setCacheHint(text){
  const el = $("cacheHint");
  if(!el) return;
  if(!text){
    el.style.display = "none";
    el.textContent = "";
    return;
  }
  el.style.display = "inline-flex";
  el.textContent = text;
}

/* ===================== Data Load ===================== */
async function loadData(){
  setHeaderStatus("DB 로딩 중...");
  setCacheHint("");

  const cached = readCache();

  try{
    const csvText = await fetchWithTimeout(CSV_URL, 8000);
    saveCache(csvText);

    Papa.parse(csvText, {
      complete: (results)=>{
        dataRows = results.data.slice(1).filter(r => r && r.length > 1);
        setHeaderStatus(`${dataRows.length.toLocaleString()}건`);
        renderTable([]); // 검색 전엔 비움
      }
    });
  }catch(err){
    console.error(err);

    if(cached){
      const when = new Date(cached.ts).toLocaleString();
      const freshness = isCacheFresh(cached.ts) ? "캐시(최신)" : "캐시(오래됨)";
      setHeaderStatus(`DB 오류 → ${freshness}로 조회`);
      setCacheHint(`캐시 사용 중 · 저장 시각: ${when}`);

      Papa.parse(cached.csvText, {
        complete: (results)=>{
          dataRows = results.data.slice(1).filter(r => r && r.length > 1);
          renderTable([]);
        }
      });
      return;
    }

    setHeaderStatus("DB 로드 실패");
    $("tableWrapper").innerHTML =
      '<div class="no-data">데이터를 불러오지 못했습니다.</div>';
  }
}
loadData();

/* ===================== Search + Sort ===================== */
const searchInput = $("searchInput");
let currentRows = [];

function applySearchAndSort(){
  const keyword = searchInput.value.trim().toLowerCase();

  let filtered = dataRows;
  if(keyword){
    filtered = dataRows.filter(row => row.join(" ").toLowerCase().includes(keyword));
  }else{
    renderTable([]);
    return;
  }

  if(sortState.key != null){
    const k = sortState.key;
    const dir = sortState.dir;
    filtered = [...filtered].sort((a,b)=>{
      const av = a[k] ?? "";
      const bv = b[k] ?? "";
      if(k === COL.QTY || k === COL.AMOUNT){
        return (toNumber(av) - toNumber(bv)) * dir;
      }
      return String(av).localeCompare(String(bv), "ko") * dir;
    });
  }

  currentRows = filtered;
  renderTable(currentRows);
}

searchInput.addEventListener("input", debounce(applySearchAndSort, 180));
searchInput.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    searchInput.value = "";
    sortState = { key: null, dir: 1 };
    renderTable([]);
    $("resultCount").textContent = "";
  }
});

/* ===================== Render ===================== */
function headerCell(label, key){
  const isOn = sortState.key === key;
  const arrow = isOn ? (sortState.dir === 1 ? "▲" : "▼") : "";
  return `
    <th data-sort="${key}">
      <span class="sort-ind">
        <span class="sort-dot ${isOn ? "on" : ""}"></span>
        <span>${label}</span>
        <span class="arrow">${arrow}</span>
      </span>
    </th>
  `;
}

function renderTable(rows){
  const wrap = $("tableWrapper");
  const count = $("resultCount");

  if(!rows || rows.length === 0){
    count.textContent = "";
    wrap.innerHTML = '<div class="no-data">검색 결과가 없습니다.</div>';
    return;
  }

  count.textContent = `${rows.length.toLocaleString()}건`;

  let html = `<table>
    <thead><tr>
      <th data-nosort style="cursor:default;">
        <span class="sort-ind"><span class="sort-dot"></span><span>#</span></span>
      </th>
      ${headerCell("주문번호", COL.ORDER_NO)}
      ${headerCell("쇼핑몰", COL.MALL)}
      ${headerCell("수령인", COL.RECEIVER)}
      ${headerCell("송장번호", COL.INVOICE)}
      <th data-nosort style="cursor:default;">
        <span class="sort-ind"><span class="sort-dot"></span><span>연락처</span></span>
      </th>
      ${headerCell("상품명", COL.PRODUCT)}
      ${headerCell("수량", COL.QTY)}
      ${headerCell("결제금액", COL.AMOUNT)}
      ${headerCell("컬러코드", COL.COLOR)}
    </tr></thead>
    <tbody>`;

  rows.forEach((r, i)=>{
    html += `<tr>
      <td class="copy" data-r="${i}" data-c="0">${i+1}</td>
      <td class="copy" data-r="${i}" data-c="1">${r[COL.ORDER_NO]||""}</td>
      <td class="copy" data-r="${i}" data-c="2">${r[COL.MALL]||""}</td>
      <td class="copy" data-r="${i}" data-c="3">${r[COL.RECEIVER]||""}</td>
      <td class="copy" data-r="${i}" data-c="4">${r[COL.INVOICE]||""}</td>
      <td class="copy" data-r="${i}" data-c="5">${r[COL.PHONE]||""}</td>
      <td class="copy" data-r="${i}" data-c="6">${r[COL.PRODUCT]||""}</td>
      <td class="copy" data-r="${i}" data-c="7">${r[COL.QTY]||""}</td>
      <td class="copy" data-r="${i}" data-c="8">${r[COL.AMOUNT]||""}</td>
      <td class="copy" data-r="${i}" data-c="9">${r[COL.COLOR]||""}</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  wrap.innerHTML = html;

  // 단일 셀 클릭 복사(원래 기능 유지)
  wrap.querySelectorAll(".copy").forEach(cell=>{
    cell.addEventListener("click", ()=>{
      const text = cell.textContent.trim();
      navigator.clipboard.writeText(text)
        .then(()=>showToast("복사됨"))
        .catch(()=>showToast("복사 실패"));
    });
  });

  // 정렬
  wrap.querySelectorAll("thead th[data-sort]").forEach(th=>{
    th.addEventListener("click", ()=>{
      const key = Number(th.dataset.sort);
      if(sortState.key === key) sortState.dir *= -1;
      else sortState = { key, dir: 1 };

      if(!searchInput.value.trim()){
        renderTable([]);
        return;
      }
      applySearchAndSort();
    });
  });
}

/* ===================== Drag Select → MouseUp Auto Copy ===================== */
(function(){
  const wrap = document.getElementById("tableWrapper");
  if(!wrap) return;

  let table = null;
  let dragging = false;
  let startCell = null;
  let endCell = null;
  let didDrag = false;

  function clearSel(){
    if(!table) return;
    table.querySelectorAll("td.sel").forEach(td => td.classList.remove("sel"));
  }

  function rc(td){
    return { r: +td.dataset.r, c: +td.dataset.c };
  }

  function paint(){
    clearSel();
    if(!startCell || !endCell || !table) return;

    const a = rc(startCell);
    const b = rc(endCell);

    const r1 = Math.min(a.r, b.r);
    const r2 = Math.max(a.r, b.r);
    const c1 = Math.min(a.c, b.c);
    const c2 = Math.max(a.c, b.c);

    for(let r=r1; r<=r2; r++){
      for(let c=c1; c<=c2; c++){
        const td = table.querySelector(`td[data-r="${r}"][data-c="${c}"]`);
        if(td) td.classList.add("sel");
      }
    }
  }

  function buildTSV(){
    if(!startCell || !endCell || !table) return "";

    const a = rc(startCell);
    const b = rc(endCell);

    const r1 = Math.min(a.r, b.r);
    const r2 = Math.max(a.r, b.r);
    const c1 = Math.min(a.c, b.c);
    const c2 = Math.max(a.c, b.c);

    const lines = [];
    for(let r=r1; r<=r2; r++){
      const row = [];
      for(let c=c1; c<=c2; c++){
        const td = table.querySelector(`td[data-r="${r}"][data-c="${c}"]`);
        row.push((td?.textContent || "").trim());
      }
      lines.push(row.join("\t"));
    }
    return lines.join("\n");
  }

  async function copySelection(){
    const tsv = buildTSV();
    if(!tsv) return;
    try{
      await navigator.clipboard.writeText(tsv);
      showToast("드래그 영역 복사됨");
    }catch{
      showToast("복사 실패");
    }
  }

  function bind(){
    table = wrap.querySelector("table");
    if(!table) return;

    table.addEventListener("mousedown", (e)=>{
      const td = e.target.closest("td.copy");
      if(!td) return;
      dragging = true;
      didDrag = false;
      startCell = endCell = td;
      paint();
      e.preventDefault();
    });

    table.addEventListener("mousemove", (e)=>{
      if(!dragging) return;
      const td = e.target.closest("td.copy");
      if(!td) return;
      if(td !== endCell) didDrag = true;
      endCell = td;
      paint();
    });

    window.addEventListener("mouseup", async ()=>{
      if(!dragging) return;
      dragging = false;

      // ✅ 마우스 놓으면 자동 복사 (드래그로 영역이 생긴 경우만)
      if(didDrag){
        await copySelection();
      }
    });
  }

  // renderTable로 테이블이 새로 그려질 때마다 재바인드
  const obs = new MutationObserver(()=>bind());
  obs.observe(wrap, { childList:true });

})();
</script>
</body>
</html>

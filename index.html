<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>주문 데이터 조회</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  body { margin:0; padding:20px; font-family:pretendard, sans-serif; background:#f8fafc; }
  .container { max-width:1200px; margin:auto; }
  h2 { font-size:22px; margin-bottom:10px; font-weight:700; }

  .row { display:flex; gap:6px; margin-bottom:10px; }
  input {
    padding:6px 10px; border:1px solid #cbd5e1;
    border-radius:8px; font-size:13px; flex:1;
  }
  button {
    padding:8px 14px; border:none; border-radius:8px;
    font-size:14px; cursor:pointer; font-weight:600;
  }
  #searchBtn { background:#6366f1; color:white; }
  #resetBtn { background:#e2e8f0; }

  table { width:100%; border-collapse:collapse; background:white; font-size:13px; margin-top:10px; }
  th,td { padding:8px; border-bottom:1px solid #e2e8f0; text-align:center; }
  thead { background:#f1f5f9; position:sticky; top:0; }
  tbody tr:hover { background:#dbeafe; cursor:pointer; }
  .sortable { cursor:pointer; }
  .no-data { padding:40px; text-align:center; color:#64748b; font-size:14px; }
  #loadStatus,#resultCount { margin:6px 0; font-size:14px; font-weight:600; }
</style>
</head>

<body>
<div class="container">
  <h2>주문 데이터 조회 (Google Sheet 연동)</h2>

  <div class="row">
    <input id="orderNo"   placeholder="주문번호">
    <input id="mall"      placeholder="쇼핑몰">
    <input id="receiver"  placeholder="수령인">
    <input id="invoice"   placeholder="송장번호">
  </div>
  <div class="row">
    <input id="phone"     placeholder="연락처(숫자)">
    <input id="product"   placeholder="상품명">
    <input id="colorCode" placeholder="컬러">
    <input id="amount"    placeholder="금액">
  </div>

  <div class="row" style="justify-content:flex-end;">
    <button id="searchBtn">조회</button>
    <button id="resetBtn">초기화</button>
  </div>

  <div id="loadStatus"></div>
  <div id="resultCount"></div>

  <div id="tableWrapper" class="no-data">검색 조건 입력 후 조회하세요.</div>
</div>

<script>
let rawData = [];
let dataRows = [];

const CSV_URL =
  "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/export?format=csv&gid=518656308";

const COL = {
  ORDER_NO: 1,
  MALL: 2,
  RECEIVER: 3,
  INVOICE: 5,
  PHONE: 6,
  PRODUCT: 10,
  QTY: 11,
  AMOUNT: 12,
  COLOR: 18
};

const searchBtn   = document.getElementById("searchBtn");
const resetBtn    = document.getElementById("resetBtn");
const loadStatus  = document.getElementById("loadStatus");
const resultCount = document.getElementById("resultCount");
const tableWrapper= document.getElementById("tableWrapper");

const inputIds = [
  "orderNo","mall","receiver","invoice","phone","product","colorCode","amount"
];

function onlyDigits(str){ return (str || "").replace(/\D/g, ""); }

function containsIgnoreCase(source, keyword) {
  if (!keyword) return true;
  if (!source) return false;
  return String(source).toLowerCase().includes(String(keyword).toLowerCase());
}

async function loadSheet() {
  loadStatus.textContent = "Google Sheet 데이터 불러오는 중...";
  searchBtn.disabled = true;

  Papa.parse(CSV_URL, {
    download:true,
    complete:(results)=>{
      rawData = results.data;
      if (!rawData || rawData.length <= 1) {
        loadStatus.textContent = "유효한 데이터가 없습니다.";
        return;
      }
      dataRows = rawData.slice(1).filter(r => r && r.length > 1);
      loadStatus.textContent = `로드 완료 (총 ${dataRows.length}건). 조건 입력 후 조회하세요.`;
      searchBtn.disabled = false;
    },
    error:()=> loadStatus.textContent = "데이터 불러오기 오류 발생"
  });
}

searchBtn.addEventListener("click", () => {
  const values = {
    orderNo   : document.getElementById("orderNo").value.trim(),
    mall      : document.getElementById("mall").value.trim(),
    receiver  : document.getElementById("receiver").value.trim(),
    invoice   : document.getElementById("invoice").value.trim(),
    phone     : onlyDigits(document.getElementById("phone").value.trim()),
    product   : document.getElementById("product").value.trim(),
    colorCode : document.getElementById("colorCode").value.trim(),
    amount    : document.getElementById("amount").value.trim()
  };

  const filtered = dataRows.filter(row => {
    return (
      containsIgnoreCase(row[COL.ORDER_NO], values.orderNo) &&
      containsIgnoreCase(row[COL.MALL], values.mall) &&
      containsIgnoreCase(row[COL.RECEIVER], values.receiver) &&
      containsIgnoreCase(row[COL.INVOICE], values.invoice) &&
      (values.phone ? onlyDigits(row[COL.PHONE]).includes(values.phone) : true) &&
      containsIgnoreCase(row[COL.PRODUCT], values.product) &&
      containsIgnoreCase(row[COL.COLOR], values.colorCode) &&
      containsIgnoreCase(row[COL.AMOUNT], values.amount)
    );
  });

  renderTable(filtered);
});

resetBtn.addEventListener("click", () => {
  inputIds.forEach(id => document.getElementById(id).value = "");
  resultCount.textContent = "";
  tableWrapper.innerHTML = '<div class="no-data">검색 조건 입력 후 조회하세요.</div>';
});

function renderTable(rows){
  if (!rows.length) {
    resultCount.textContent = "검색 결과 0건";
    tableWrapper.innerHTML = '<div class="no-data">조건에 맞는 데이터가 없습니다.</div>';
    return;
  }

  resultCount.textContent = `검색 결과 ${rows.length}건`;

  let html = `
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th class="sortable">주문번호(B)</th>
        <th>쇼핑몰(C)</th>
        <th>수령인(D)</th>
        <th>송장번호(F)</th>
        <th>연락처(G)</th>
        <th>상품명(K)</th>
        <th>수량(L)</th>
        <th>금액(M)</th>
        <th>컬러(S)</th>
      </tr>
    </thead>
    <tbody>
  `;

  rows.forEach((row,i)=>{
    html += `
      <tr onclick="goSheet(${i+2})">
        <td>${i+1}</td>
        <td>${row[COL.ORDER_NO] || ""}</td>
        <td>${row[COL.MALL] || ""}</td>
        <td>${row[COL.RECEIVER] || ""}</td>
        <td>${row[COL.INVOICE] || ""}</td>
        <td>${row[COL.PHONE] || ""}</td>
        <td>${row[COL.PRODUCT] || ""}</td>
        <td>${row[COL.QTY] || ""}</td>
        <td>${row[COL.AMOUNT] || ""}</td>
        <td>${row[COL.COLOR] || ""}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  tableWrapper.innerHTML = html;
}

function goSheet(row){
  window.open(`https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/edit#gid=518656308&range=A${row}`);
}

window.onload = loadSheet;
</script>
</body>
</html>

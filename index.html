<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>발주서 - Supabase</title>

<link rel="stylesheet" as="style" crossorigin
  href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css">

<style>
:root {
  --bg-gradient: radial-gradient(circle at top left, #f9a8d4 0, #e5e7eb 40%, #e0f2fe 100%);
  --card-bg: rgba(255, 255, 255, 0.96);
  --border-soft: rgba(148, 163, 184, 0.5);
  --accent: #2563eb;
  --accent-soft: rgba(37, 99, 235, 0.08);
  --text-main: #0f172a;
  --text-sub: #64748b;
}
*{box-sizing:border-box;font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
body{margin:0;min-height:100vh;padding:32px 16px;color:var(--text-main);background:var(--bg-gradient);}
.container{max-width:1200px;margin:0 auto;}
.card{background:var(--card-bg);border-radius:18px;padding:24px 24px 20px;box-shadow:0 18px 45px rgba(15,23,42,0.12),0 0 0 1px rgba(148,163,184,0.35);border:1px solid rgba(248,250,252,0.7);backdrop-filter:blur(12px);}
.card-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:18px;gap:12px;flex-wrap:wrap;}
.card-title{font-size:20px;font-weight:700;display:flex;gap:8px;align-items:center;}
.card-title-badge{font-size:11px;padding:3px 8px;border-radius:999px;background:var(--accent-soft);color:var(--accent);border:1px solid rgba(37,99,235,0.2);}
.card-subtitle{font-size:12px;color:var(--text-sub);}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0;}
.btn{border-radius:999px;border:1px solid var(--border-soft);padding:6px 14px;font-size:12px;cursor:pointer;background:#fff;}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent);}
.btn-danger{background:#ef4444;color:#fff;border-color:#ef4444;}
.btn:disabled{opacity:0.5;cursor:default;}
.status{font-size:11px;color:var(--text-sub);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin:8px 0 10px;}
.table-wrapper{max-height:420px;overflow:auto;border-radius:10px;border:1px solid rgba(148,163,184,0.4);background:rgba(248,250,252,0.9);}
table{width:100%;border-collapse:collapse;font-size:12px;}
thead{position:sticky;top:0;background:rgba(241,245,249,0.98);backdrop-filter:blur(6px);}
th,td{padding:6px 8px;border-bottom:1px solid rgba(226,232,240,0.8);vertical-align:top;}
tbody tr:nth-child(even){background:rgba(255,255,255,0.8);}
tbody tr:hover{background:rgba(219,234,254,0.7);}
.no-data{padding:14px;text-align:center;font-size:12px;color:var(--text-sub);}
.field{display:flex;flex-direction:column;gap:4px;margin-bottom:12px;}
.field input{border-radius:9px;border:1px solid var(--border-soft);padding:8px 10px;font-size:12px;outline:none;background:rgba(248,250,252,0.9);}
.field input:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(37,99,235,0.2);background:#fff;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media (max-width: 720px){ .grid{grid-template-columns:1fr;} }
.sep{height:1px;background:rgba(226,232,240,0.9);margin:14px 0;}
.small{font-size:11px;color:var(--text-sub);}
kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:11px;background:rgba(15,23,42,0.06);border:1px solid rgba(148,163,184,0.35);padding:2px 6px;border-radius:6px;}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">정보 조회 <span class="card-title-badge">Supabase DB</span></div>
        <div class="card-subtitle">엑셀 업로드 → DB 저장(중복 자동 덮어쓰기) → 빠른 검색</div>
      </div>
      <div class="small" id="authState">로그인 필요</div>
    </div>

    <!-- 로그인 -->
    <div id="authBox">
      <div class="grid">
        <div class="field">
          <input id="email" type="email" placeholder="이메일" autocomplete="email" />
        </div>
        <div class="field">
          <input id="password" type="password" placeholder="비밀번호" autocomplete="current-password" />
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" id="loginBtn">로그인</button>
        <button class="btn" id="signupBtn">회원가입</button>
      </div>
      <div class="small">※ 처음 1번만 회원가입 → 이후 로그인해서 사용</div>
      <div class="sep"></div>
    </div>

    <!-- 업로드 / 검색 -->
    <div id="appBox" style="display:none;">
      <div class="grid">
        <div class="field">
          <input id="searchInput" type="text" placeholder="주문번호, 수령인, 상품명 등 전체 검색 (서버 검색)" />
          <div class="small">팁: 검색 후 <kbd>Enter</kbd> 또는 잠시 멈추면 자동 조회</div>
        </div>
        <div class="field">
          <input id="fileInput" type="file" accept=".xlsx,.xls" />
          <div class="small">엑셀 첫 행은 머릿글(헤더)로 인식</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" id="uploadBtn">엑셀 업로드(중복 덮어쓰기)</button>
        <button class="btn" id="refreshBtn">최근 데이터 불러오기</button>
        <button class="btn" id="resetBtn">검색 초기화</button>
        <button class="btn btn-danger" id="logoutBtn">로그아웃</button>
      </div>

      <div class="status">
        <span id="loadStatus">대기 중</span>
        <span id="resultCount"></span>
      </div>

      <div class="table-wrapper" id="tableWrapper">
        <div class="no-data">로그인 후 데이터를 불러오세요.</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // 1) Supabase
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
  // 2) Excel parser (SheetJS)
  import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

  const supabaseUrl = "https://uavgqjijapwunjhpokmg.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhdmdxamlqYXB3dW5qaHBva21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2ODUzMTUsImV4cCI6MjA4MTI2MTMxNX0.JkQpf3RoPaDXVUNV_YrvzXs28uHtYQMwn5GZPNJzTv4";
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  // --- DOM
  const authState = document.getElementById("authState");
  const authBox = document.getElementById("authBox");
  const appBox = document.getElementById("appBox");

  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("password");
  const loginBtn = document.getElementById("loginBtn");
  const signupBtn = document.getElementById("signupBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const searchInput = document.getElementById("searchInput");
  const fileInput = document.getElementById("fileInput");
  const uploadBtn = document.getElementById("uploadBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const resetBtn = document.getElementById("resetBtn");

  const loadStatus = document.getElementById("loadStatus");
  const resultCount = document.getElementById("resultCount");
  const tableWrapper = document.getElementById("tableWrapper");

  // --- helpers
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const setStatus = (msg) => loadStatus.textContent = msg;

  function normHeader(s){
    return String(s ?? "").trim();
  }

  // 사방넷 주문번호 헤더 후보(엑셀마다 표기 흔들릴 수 있어서 대비)
  const SHABANG_HEADER_CANDIDATES = new Set([
    "주문번호(샤방넷)",
    "주문번호(사방넷)",
    "사방넷주문번호",
    "샤방넷주문번호",
    "사방넷 주문번호",
    "샤방넷 주문번호",
    "주문번호"
  ]);

  function pickValue(rowObj, headerNames){
    for (const h of headerNames){
      if (rowObj[h] != null && String(rowObj[h]).trim() !== "") return rowObj[h];
    }
    return null;
  }

  function formatMoney(v){
    if (v == null || v === "") return "";
    const n = Number(String(v).replaceAll(",", ""));
    if (Number.isFinite(n)) return n.toLocaleString("ko-KR");
    return String(v);
  }

  function renderTable(rows){
    if(!rows || rows.length===0){
      resultCount.textContent = "";
      tableWrapper.innerHTML = '<div class="no-data">검색 결과가 없습니다.</div>';
      return;
    }
    resultCount.textContent = `검색 결과 ${rows.length}건`;

    let html = `<table><thead><tr>
      <th>#</th>
      <th>사방넷 주문번호</th>
      <th>쇼핑몰</th>
      <th>쇼핑몰 주문번호</th>
      <th>수령인</th>
      <th>송장번호</th>
      <th>연락처</th>
      <th>상품명</th>
      <th>수량</th>
      <th>결제금액</th>
      <th>컬러코드</th>
    </tr></thead><tbody>`;

    rows.forEach((r,i)=>{
      html += `<tr>
        <td class="copy-cell">${i+1}</td>
        <td class="copy-cell">${r.shabang_order_no ?? ""}</td>
        <td class="copy-cell">${r.mall ?? ""}</td>
        <td class="copy-cell">${r.mall_order_no ?? ""}</td>
        <td class="copy-cell">${r.receiver ?? ""}</td>
        <td class="copy-cell">${r.invoice ?? ""}</td>
        <td class="copy-cell">${r.phone ?? ""}</td>
        <td class="copy-cell">${r.product ?? ""}</td>
        <td class="copy-cell">${r.qty ?? ""}</td>
        <td class="copy-cell">${formatMoney(r.amount)}</td>
        <td class="copy-cell">${r.color_code ?? ""}</td>
      </tr>`;
    });

    html += `</tbody></table>`;
    tableWrapper.innerHTML = html;

    tableWrapper.querySelectorAll(".copy-cell").forEach(cell=>{
      cell.addEventListener("click", ()=>{
        navigator.clipboard.writeText(cell.textContent).catch(()=>{});
      });
    });
  }

  async function fetchRecent(){
    setStatus("최근 데이터 불러오는 중...");
    const { data, error } = await supabase
      .from("orders")
      .select("shabang_order_no, mall, mall_order_no, receiver, phone, invoice, product, qty, amount, color_code, updated_at")
      .order("updated_at", { ascending: false })
      .limit(200);

    if (error) {
      console.error(error);
      setStatus("불러오기 실패(권한/로그인/RLS 확인)");
      renderTable([]);
      return;
    }
    setStatus(`불러오기 완료 (최근 ${data.length}건)`);
    renderTable(data);
  }

  let searchTimer = null;
  async function runSearch(){
    const keyword = searchInput.value.trim();
    if (!keyword){
      await fetchRecent();
      return;
    }
    setStatus("검색 중...");
    const k = keyword.replaceAll("%","").replaceAll(","," ").trim();

    // 여러 컬럼 OR 검색 (DB에서 처리)
    const { data, error } = await supabase
      .from("orders")
      .select("shabang_order_no, mall, mall_order_no, receiver, phone, invoice, product, qty, amount, color_code, updated_at")
      .or([
        `shabang_order_no.ilike.%${k}%`,
        `receiver.ilike.%${k}%`,
        `product.ilike.%${k}%`,
        `mall.ilike.%${k}%`,
        `mall_order_no.ilike.%${k}%`,
        `invoice.ilike.%${k}%`,
        `phone.ilike.%${k}%`,
        `color_code.ilike.%${k}%`
      ].join(","))
      .order("updated_at", { ascending: false })
      .limit(200);

    if (error){
      console.error(error);
      setStatus("검색 실패");
      renderTable([]);
      return;
    }
    setStatus(`검색 완료`);
    renderTable(data);
  }

  // --- Auth
  async function refreshSessionUI(){
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user){
      authState.textContent = `로그인됨: ${session.user.email}`;
      authBox.style.display = "none";
      appBox.style.display = "block";
      await fetchRecent();
    } else {
      authState.textContent = "로그인 필요";
      authBox.style.display = "block";
      appBox.style.display = "none";
      tableWrapper.innerHTML = '<div class="no-data">로그인 후 데이터를 불러오세요.</div>';
      setStatus("대기 중");
      resultCount.textContent = "";
    }
  }

  loginBtn.addEventListener("click", async ()=>{
    setStatus("로그인 중...");
    const email = emailEl.value.trim();
    const password = passEl.value.trim();
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error){
      console.error(error);
      setStatus("로그인 실패(이메일/비번 확인)");
      return;
    }
    setStatus("로그인 완료");
    await refreshSessionUI();
  });

  signupBtn.addEventListener("click", async ()=>{
    setStatus("회원가입 중...");
    const email = emailEl.value.trim();
    const password = passEl.value.trim();
    const { error } = await supabase.auth.signUp({ email, password });
    if (error){
      console.error(error);
      setStatus("회원가입 실패(이미 가입/비번 규칙 등)");
      return;
    }
    setStatus("회원가입 완료! 이제 로그인 해주세요.");
  });

  logoutBtn.addEventListener("click", async ()=>{
    await supabase.auth.signOut();
    await refreshSessionUI();
  });

  supabase.auth.onAuthStateChange(() => refreshSessionUI());

  // --- Search UX
  searchInput.addEventListener("input", ()=>{
    clearTimeout(searchTimer);
    searchTimer = setTimeout(runSearch, 250);
  });
  searchInput.addEventListener("keydown", (e)=>{
    if (e.key === "Enter") runSearch();
  });
  resetBtn.addEventListener("click", async ()=>{
    searchInput.value = "";
    await fetchRecent();
  });
  refreshBtn.addEventListener("click", fetchRecent);

  // --- Excel Upload → Upsert
  uploadBtn.addEventListener("click", async ()=>{
    const file = fileInput.files?.[0];
    if (!file){
      alert("엑셀 파일(.xlsx)을 선택해 주세요.");
      return;
    }

    setStatus("엑셀 읽는 중...");
    uploadBtn.disabled = true;

    try {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });

      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];

      // header: 1 -> 첫 행을 key로 하는 객체 배열
      const rows = XLSX.utils.sheet_to_json(ws, { defval: "", raw: false });

      if (!rows.length){
        setStatus("엑셀에 데이터가 없습니다.");
        return;
      }

      // 실제 헤더명 목록
      const headers = Object.keys(rows[0] || {}).map(normHeader);

      // 사방넷 주문번호 컬럼 찾기
      const shabangHeader = headers.find(h => SHABANG_HEADER_CANDIDATES.has(h));
      if (!shabangHeader){
        setStatus("엑셀에서 '주문번호(샤방넷)' 컬럼을 찾지 못했습니다.");
        alert("엑셀 머릿글에 '주문번호(샤방넷)'(또는 유사 표기)이 있어야 합니다.");
        return;
      }

      // 매핑(너 엑셀에서 자주 쓰는 필드들)
      const mapped = [];
      for (const r of rows){
        const shabang = String(r[shabangHeader] ?? "").trim();
        if (!shabang) continue; // 주문번호 없으면 저장 불가(중복키라서)

        mapped.push({
          shabang_order_no: shabang,
          mall: String(pickValue(r, ["쇼핑몰"]) ?? "").trim() || null,
          mall_order_no: String(pickValue(r, ["쇼핑몰 주문번호(필수)", "쇼핑몰주문번호", "쇼핑몰 주문번호"]) ?? "").trim() || null,
          receiver: String(pickValue(r, ["수령인", "받는분", "수취인"]) ?? "").trim() || null,
          phone: String(pickValue(r, ["받는분연락처", "연락처", "수령인 연락처", "전화번호"]) ?? "").trim() || null,
          invoice: String(pickValue(r, ["송장번호", "운송장번호"]) ?? "").trim() || null,
          product: String(pickValue(r, ["상품명", "상품"]) ?? "").trim() || null,
          qty: (() => {
            const v = pickValue(r, ["수량"]);
            const n = Number(String(v).replaceAll(",", "").trim());
            return Number.isFinite(n) ? n : null;
          })(),
          amount: (() => {
            const v = pickValue(r, ["결제금액", "금액", "총 결제금액"]);
            const n = Number(String(v).replaceAll(",", "").trim());
            return Number.isFinite(n) ? n : null;
          })(),
          color_code: String(pickValue(r, ["상품컬러코드", "컬러코드", "색상코드"]) ?? "").trim() || null,
          raw: r,
          updated_at: new Date().toISOString()
        });
      }

      if (!mapped.length){
        setStatus("저장할 행이 없습니다(주문번호가 비어있음).");
        return;
      }

      setStatus(`DB 저장 중... (${mapped.length}행, 중복 자동 덮어쓰기)`);
      // upsert: unique(shabang_order_no) 기준
      const { error } = await supabase
        .from("orders")
        .upsert(mapped, { onConflict: "shabang_order_no" });

      if (error){
        console.error(error);
        setStatus("DB 저장 실패(권한/RLS/로그인 확인)");
        alert("DB 저장 실패. 콘솔 오류를 확인하세요.");
        return;
      }

      setStatus(`저장 완료! (${mapped.length}행 처리)`);
      await sleep(200);
      await fetchRecent();

    } catch (e){
      console.error(e);
      setStatus("업로드 처리 중 오류");
      alert("엑셀 처리 중 오류가 발생했습니다. 콘솔을 확인해 주세요.");
    } finally {
      uploadBtn.disabled = false;
    }
  });

  // init
  await refreshSessionUI();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>주문 데이터 조회</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { margin:0; padding:20px; font-family:pretendard,sans-serif; background:#eef2ff; }
    .container { max-width:1200px; margin:auto; }
    .title { font-size:22px; font-weight:700; margin-bottom:10px; }
    .filters { display:flex; gap:6px; margin-bottom:10px; }
    input,select {
      padding:6px 10px; border-radius:8px; border:1px solid #cbd5e1;
    }
    table { width:100%; border-collapse:collapse; font-size:13px; background:white; }
    th, td { padding:8px; border-bottom:1px solid #e2e8f0; white-space:nowrap; }
    thead { position: sticky; top:0; background:#f1f5f9; }
    tbody tr:hover { background:#dbeafe; cursor:pointer; }
    .sortable { cursor:pointer; }
  </style>
</head>
<body>
<div class="container">
  <div class="title">주문 데이터 조회 (Google Sheet 연동)</div>

  <div class="filters">
    <input id="searchText" placeholder="검색어 입력 (상품/수령인/연락처)">
    <select id="colorFilter"><option value="">컬러 전체</option></select>
    <select id="productFilter"><option value="">상품 전체</option></select>
  </div>

  <div id="status"></div>

  <div id="tableWrapper">불러오는 중...</div>
</div>

<script>
const SHEET_URL =
 "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/export?format=csv&gid=518656308";

let data = [];
let filteredData = [];
let sortDir = 1;

function loadSheet(){
  document.getElementById("status").innerText="Google Sheet 데이터 로딩중...";

  fetch(SHEET_URL)
    .then(res => res.text())
    .then(csv => {
      Papa.parse(csv, {
        complete: (result)=>{
          data = result.data.slice(1).filter(r=>r.length>2);
          filteredData = [...data];
          buildFilters();
          renderTable(filteredData);
          document.getElementById("status").innerText=`총 ${data.length}건`;
        }
      });
    })
}

function buildFilters(){
  const colors=[...new Set(data.map(r=>r[18]).filter(Boolean))];
  const products=[...new Set(data.map(r=>r[10]).filter(Boolean))];

  colors.forEach(c=>{
    document.getElementById("colorFilter").innerHTML += `<option>${c}</option>`;
  });
  products.forEach(p=>{
    document.getElementById("productFilter").innerHTML += `<option>${p}</option>`;
  });
}

function renderTable(rows){
  let html = `<table>
    <thead>
      <tr>
        <th class="sortable" onclick="sortTable(1)">주문번호 ↑↓</th>
        <th>쇼핑몰</th>
        <th>수령인</th>
        <th>연락처</th>
        <th>상품</th>
        <th>컬러</th>
      </tr>
    </thead><tbody>
  `;

  rows.forEach((r,i)=>{
    html+=`
      <tr onclick="goSheet(${i+2})">
        <td>${r[1]}</td>
        <td>${r[2]}</td>
        <td>${r[3]}</td>
        <td>${r[6]}</td>
        <td>${r[10]}</td>
        <td>${r[18]}</td>
      </tr>
    `;
  });

  html+="</tbody></table>";
  document.getElementById("tableWrapper").innerHTML = html;
}

function goSheet(row){
  window.open(`https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/edit#gid=518656308&range=A${row}`);
}

function applyFilter(){
  const s = document.getElementById("searchText").value.toLowerCase();
  const color = document.getElementById("colorFilter").value;
  const product = document.getElementById("productFilter").value;

  filteredData = data.filter(r=>{
    return (
      (r.join(" ").toLowerCase().includes(s)) &&
      (color=="" || r[18]==color) &&
      (product=="" || r[10]==product)
    );
  });

  document.getElementById("status").innerText = `검색 결과 ${filteredData.length}건`;
  renderTable(filteredData);
}

function sortTable(col){
  sortDir *=-1;
  filteredData.sort((a,b)=> a[col] > b[col] ? sortDir : -sortDir);
  renderTable(filteredData);
}

document.getElementById("searchText").addEventListener("input",applyFilter);
document.getElementById("colorFilter").addEventListener("change",applyFilter);
document.getElementById("productFilter").addEventListener("change",applyFilter);

loadSheet();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>정보 조회 - Supabase</title>

<link rel="stylesheet" as="style" crossorigin
  href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css">

<style>
:root {
  --bg-gradient: radial-gradient(circle at top left, #f9a8d4 0, #e5e7eb 40%, #e0f2fe 100%);
  --card-bg: rgba(255, 255, 255, 0.96);
  --border-soft: rgba(148, 163, 184, 0.5);
  --accent: #2563eb;
  --accent-soft: rgba(37, 99, 235, 0.08);
  --text-main: #0f172a;
  --text-sub: #64748b;
}
*{box-sizing:border-box;font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
body{margin:0;min-height:100vh;padding:32px 16px;color:var(--text-main);background:var(--bg-gradient);}
.container{max-width:1200px;margin:0 auto;}
.card{background:var(--card-bg);border-radius:18px;padding:24px 24px 20px;box-shadow:0 18px 45px rgba(15,23,42,0.12),0 0 0 1px rgba(148,163,184,0.35);border:1px solid rgba(248,250,252,0.7);backdrop-filter:blur(12px);}
.card-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:18px;gap:12px;flex-wrap:wrap;}
.card-title{font-size:20px;font-weight:700;display:flex;gap:8px;align-items:center;}
.card-title-badge{font-size:11px;padding:3px 8px;border-radius:999px;background:var(--accent-soft);color:var(--accent);border:1px solid rgba(37,99,235,0.2);}
.card-subtitle{font-size:12px;color:var(--text-sub);}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0;}
.btn{border-radius:999px;border:1px solid var(--border-soft);padding:6px 14px;font-size:12px;cursor:pointer;background:#fff;}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent);}
.btn:disabled{opacity:0.5;cursor:default;}
.status{font-size:11px;color:var(--text-sub);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin:8px 0 10px;}
.table-wrapper{max-height:520px;overflow:auto;border-radius:10px;border:1px solid rgba(148,163,184,0.4);background:rgba(248,250,252,0.9);}
table{width:100%;border-collapse:collapse;font-size:12px;}
thead{position:sticky;top:0;background:rgba(241,245,249,0.98);backdrop-filter:blur(6px);}
th,td{padding:6px 8px;border-bottom:1px solid rgba(226,232,240,0.8);vertical-align:top;}
tbody tr:nth-child(even){background:rgba(255,255,255,0.8);}
tbody tr:hover{background:rgba(219,234,254,0.7);}
.no-data{padding:14px;text-align:center;font-size:12px;color:var(--text-sub);}
.field{display:flex;flex-direction:column;gap:4px;margin-bottom:12px;}
.field input{border-radius:9px;border:1px solid var(--border-soft);padding:8px 10px;font-size:12px;outline:none;background:rgba(248,250,252,0.9);}
.field input:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(37,99,235,0.2);background:#fff;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media (max-width: 720px){ .grid{grid-template-columns:1fr;} }
.small{font-size:11px;color:var(--text-sub);}
kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:11px;background:rgba(15,23,42,0.06);border:1px solid rgba(148,163,184,0.35);padding:2px 6px;border-radius:6px;}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">정보 조회 <span class="card-title-badge">Supabase DB</span></div>
        <div class="card-subtitle">로그인 없이 사용 (링크를 공유하지 마세요)</div>
      </div>
      <div class="small">anon 모드</div>
    </div>

    <div class="grid">
      <div class="field">
        <input id="searchInput" type="text" placeholder="주문번호, 수령인, 상품명 등 검색 (Enter)" />
        <div class="small">팁: 입력 후 <kbd>Enter</kbd> 또는 잠시 멈추면 자동 검색</div>
      </div>
      <div class="field">
        <input id="fileInput" type="file" accept=".xlsx,.xls" />
        <div class="small">엑셀 첫 행은 머릿글(헤더)</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="uploadBtn">엑셀 업로드(중복 덮어쓰기)</button>
      <button class="btn" id="refreshBtn">최근 200건</button>
      <button class="btn" id="resetBtn">검색 초기화</button>
    </div>

    <div class="status">
      <span id="loadStatus">대기 중</span>
      <span id="resultCount"></span>
    </div>

    <div class="table-wrapper" id="tableWrapper">
      <div class="no-data">최근 200건을 불러오거나 검색하세요.</div>
    </div>
  </div>
</div>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

<script>
  const sb = window.supabase.createClient(
    "https://uavgqjijapwunjhpokmg.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhdmdxamlqYXB3dW5qaHBva21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2ODUzMTUsImV4cCI6MjA4MTI2MTMxNX0.JkQpf3RoPaDXVUNV_YrvzXs28uHtYQMwn5GZPNJzTv4"
  );

  const searchInput = document.getElementById("searchInput");
  const fileInput = document.getElementById("fileInput");
  const uploadBtn = document.getElementById("uploadBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const resetBtn = document.getElementById("resetBtn");
  const loadStatus = document.getElementById("loadStatus");
  const resultCount = document.getElementById("resultCount");
  const tableWrapper = document.getElementById("tableWrapper");

  const SHABANG_HEADER_CANDIDATES = new Set([
    "주문번호(샤방넷)",
    "주문번호(사방넷)",
    "사방넷주문번호",
    "샤방넷주문번호",
    "사방넷 주문번호",
    "샤방넷 주문번호",
    "주문번호"
  ]);

  function pickValue(rowObj, headerNames){
    for (const h of headerNames){
      if (rowObj[h] != null && String(rowObj[h]).trim() !== "") return rowObj[h];
    }
    return null;
  }

  function formatMoney(v){
    if (v == null || v === "") return "";
    const n = Number(String(v).replaceAll(",", ""));
    return Number.isFinite(n) ? n.toLocaleString("ko-KR") : String(v);
  }

  function renderTable(rows){
    if(!rows || rows.length===0){
      resultCount.textContent = "";
      tableWrapper.innerHTML = '<div class="no-data">검색 결과가 없습니다.</div>';
      return;
    }
    resultCount.textContent = `검색 결과 ${rows.length}건`;

    let html = `<table><thead><tr>
      <th>#</th><th>사방넷주문번호</th><th>쇼핑몰</th><th>쇼핑몰주문번호</th><th>수령인</th>
      <th>송장번호</th><th>연락처</th><th>상품명</th><th>수량</th><th>결제금액</th><th>컬러코드</th>
    </tr></thead><tbody>`;

    rows.forEach((r,i)=>{
      html += `<tr>
        <td class="copy-cell">${i+1}</td>
        <td class="copy-cell">${r.shabang_order_no ?? ""}</td>
        <td class="copy-cell">${r.mall ?? ""}</td>
        <td class="copy-cell">${r.mall_order_no ?? ""}</td>
        <td class="copy-cell">${r.receiver ?? ""}</td>
        <td class="copy-cell">${r.invoice ?? ""}</td>
        <td class="copy-cell">${r.phone ?? ""}</td>
        <td class="copy-cell">${r.product ?? ""}</td>
        <td class="copy-cell">${r.qty ?? ""}</td>
        <td class="copy-cell">${formatMoney(r.amount)}</td>
        <td class="copy-cell">${r.color_code ?? ""}</td>
      </tr>`;
    });

    html += `</tbody></table>`;
    tableWrapper.innerHTML = html;

    tableWrapper.querySelectorAll(".copy-cell").forEach(cell=>{
      cell.addEventListener("click", ()=>{
        navigator.clipboard.writeText(cell.textContent).catch(()=>{});
      });
    });
  }

  async function fetchRecent(){
    loadStatus.textContent = "최근 데이터 불러오는 중...";
    const { data, error } = await sb
      .from("orders")
      .select("shabang_order_no, mall, mall_order_no, receiver, phone, invoice, product, qty, amount, color_code, updated_at")
      .order("updated_at", { ascending: false })
      .limit(200);

    if (error) {
      console.error(error);
      loadStatus.textContent = "불러오기 실패(RLS/정책 확인)";
      renderTable([]);
      return;
    }
    loadStatus.textContent = `불러오기 완료 (최근 ${data.length}건)`;
    renderTable(data);
  }

  let searchTimer = null;
  async function runSearch(){
    const keyword = searchInput.value.trim();
    if (!keyword){
      await fetchRecent();
      return;
    }
    loadStatus.textContent = "검색 중...";
    const k = keyword.replaceAll("%","").replaceAll(","," ").trim();

    const { data, error } = await sb
      .from("orders")
      .select("shabang_order_no, mall, mall_order_no, receiver, phone, invoice, product, qty, amount, color_code, updated_at")
      .or([
        `shabang_order_no.ilike.%${k}%`,
        `receiver.ilike.%${k}%`,
        `product.ilike.%${k}%`,
        `mall.ilike.%${k}%`,
        `mall_order_no.ilike.%${k}%`,
        `invoice.ilike.%${k}%`,
        `phone.ilike.%${k}%`,
        `color_code.ilike.%${k}%`
      ].join(","))
      .order("updated_at", { ascending: false })
      .limit(200);

    if (error){
      console.error(error);
      loadStatus.textContent = "검색 실패";
      renderTable([]);
      return;
    }
    loadStatus.textContent = `검색 완료`;
    renderTable(data);
  }

  searchInput.addEventListener("input", ()=>{
    clearTimeout(searchTimer);
    searchTimer = setTimeout(runSearch, 250);
  });
  searchInput.addEventListener("keydown", (e)=>{
    if (e.key === "Enter") runSearch();
  });
  resetBtn.addEventListener("click", async ()=>{
    searchInput.value = "";
    await fetchRecent();
  });
  refreshBtn.addEventListener("click", fetchRecent);

  uploadBtn.addEventListener("click", async ()=>{
    const file = fileInput.files?.[0];
    if (!file){
      alert("엑셀 파일(.xlsx)을 선택해 주세요.");
      return;
    }

    uploadBtn.disabled = true;
    loadStatus.textContent = "엑셀 읽는 중...";

    try{
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { defval: "", raw: false });

      if (!rows.length){
        loadStatus.textContent = "엑셀에 데이터가 없습니다.";
        return;
      }

      const headers = Object.keys(rows[0] || {}).map(h => String(h).trim());
      const shabangHeader = headers.find(h => SHABANG_HEADER_CANDIDATES.has(h));
      if (!shabangHeader){
        alert("엑셀 머릿글에 '주문번호(샤방넷)'(또는 유사 표기)이 있어야 합니다.");
        loadStatus.textContent = "머릿글 인식 실패";
        return;
      }

      const mapped = [];
      for (const r of rows){
        const shabang = String(r[shabangHeader] ?? "").trim();
        if (!shabang) continue;

        mapped.push({
          shabang_order_no: shabang,
          mall: String(pickValue(r, ["쇼핑몰"]) ?? "").trim() || null,
          mall_order_no: String(pickValue(r, ["쇼핑몰 주문번호(필수)", "쇼핑몰 주문번호"]) ?? "").trim() || null,
          receiver: String(pickValue(r, ["수령인", "수취인", "받는분"]) ?? "").trim() || null,
          phone: String(pickValue(r, ["받는분연락처", "연락처", "전화번호"]) ?? "").trim() || null,
          invoice: String(pickValue(r, ["송장번호", "운송장번호"]) ?? "").trim() || null,
          product: String(pickValue(r, ["상품명", "상품"]) ?? "").trim() || null,
          qty: (() => {
            const v = pickValue(r, ["수량"]);
            const n = Number(String(v).replaceAll(",", "").trim());
            return Number.isFinite(n) ? n : null;
          })(),
          amount: (() => {
            const v = pickValue(r, ["결제금액", "금액", "총 결제금액"]);
            const n = Number(String(v).replaceAll(",", "").trim());
            return Number.isFinite(n) ? n : null;
          })(),
          color_code: String(pickValue(r, ["상품컬러코드", "컬러코드", "색상코드"]) ?? "").trim() || null,
          raw: r,
          updated_at: new Date().toISOString()
        });
      }

      if (!mapped.length){
        loadStatus.textContent = "저장할 행이 없습니다(주문번호 비어있음).";
        return;
      }

      loadStatus.textContent = `DB 저장 중... (${mapped.length}행 / 중복 덮어쓰기)`;
      const { error } = await sb
        .from("orders")
        .upsert(mapped, { onConflict: "shabang_order_no" });

      if (error){
        console.error(error);
        alert("DB 저장 실패: " + error.message);
        loadStatus.textContent = "DB 저장 실패";
        return;
      }

      alert(`저장 완료! (${mapped.length}행 처리)`);
      loadStatus.textContent = `저장 완료 (${mapped.length}행)`;
      await fetchRecent();

    } catch(e){
      console.error(e);
      alert("업로드 처리 오류. 콘솔(F12)을 확인해 주세요.");
      loadStatus.textContent = "업로드 오류";
    } finally{
      uploadBtn.disabled = false;
    }
  });

  // 첫 화면: 최근 200건 자동 로드(원하면 주석처리)
  fetchRecent();
</script>

</body>
</html>

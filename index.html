<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>발주서</title>

<link rel="icon" type="image/png" href="android-icon-48x48.ico">
<link rel="stylesheet" as="style" crossorigin
 href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg: radial-gradient(circle at top left,#f9a8d4 0,#e5e7eb 40%,#e0f2fe 100%);
  --card: rgba(255,255,255,.96);
  --border: rgba(148,163,184,.45);
  --accent:#2563eb;
  --text:#0f172a;
  --sub:#64748b;
}
*{box-sizing:border-box;font-family:Pretendard,system-ui}
body{margin:0;padding:32px 16px;background:var(--bg);color:var(--text)}
.container{max-width:1200px;margin:auto}
.card{
  background:var(--card);border-radius:18px;padding:24px;
  box-shadow:0 18px 45px rgba(15,23,42,.12);
}
.card-title{font-size:20px;font-weight:700}
.field{margin:14px 0}
input{
  width:100%;padding:10px 12px;font-size:13px;
  border-radius:10px;border:1px solid var(--border)
}
.status{font-size:11px;color:var(--sub);display:flex;justify-content:space-between}
.table-wrapper{
  margin-top:10px;border-radius:12px;overflow:auto;
  border:1px solid var(--border);max-height:520px
}
table{width:100%;border-collapse:collapse;font-size:12px}
thead{position:sticky;top:0;background:#f1f5f9}
th,td{padding:8px 10px;border-bottom:1px solid #e5e7eb}
th{cursor:pointer;user-select:none}
tbody tr:hover{background:#dbeafe}
.copy{cursor:pointer}
.no-data{text-align:center;padding:20px;color:var(--sub)}
#toast{
  position:fixed;right:16px;bottom:16px;
  background:#0f172a;color:#fff;
  padding:8px 12px;border-radius:10px;
  font-size:12px;opacity:0;transition:.2s
}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="card-title">정보 조회</div>

    <div class="field">
      <input id="search" placeholder="주문번호 · 수령인 · 상품명 검색 (Esc 초기화)">
    </div>

    <div class="status">
      <span id="status">DB 로딩 중...</span>
      <span id="count"></span>
    </div>

    <div class="table-wrapper" id="table">
      <div class="no-data">데이터 로딩 중...</div>
    </div>
  </div>
</div>

<div id="toast">복사됨</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/export?format=csv&gid=518656308";

const COL = { ORDER:1, MALL:2, NAME:3, INVOICE:5, PHONE:6, PRODUCT:10, QTY:11, AMOUNT:12, COLOR:18 };
let rows = [];
let sort = { key:null, dir:1 };

// ===== cache =====
const CK="csv_cache", CT="csv_cache_time";
async function fetchCSV(){
  try{
    const r = await fetch(CSV_URL,{signal:AbortSignal.timeout(8000)});
    const t = await r.text();
    localStorage.setItem(CK,t);
    localStorage.setItem(CT,Date.now());
    return t;
  }catch{
    return localStorage.getItem(CK);
  }
}

// ===== load =====
fetchCSV().then(csv=>{
  if(!csv){
    status.textContent="DB 로드 실패";
    table.innerHTML='<div class="no-data">데이터 없음</div>';
    return;
  }
  Papa.parse(csv,{
    complete:r=>{
      rows=r.data.slice(1).filter(v=>v.length);
      status.textContent=`DB 로드 완료 (${rows.length}건)`;
    }
  });
});

// ===== utils =====
function toast(){
  const t=document.getElementById("toast");
  t.style.opacity=1;
  setTimeout(()=>t.style.opacity=0,800);
}
function num(v){return Number(String(v).replace(/[^0-9.-]/g,""))||0}

// ===== render =====
function render(data){
  if(!data.length){
    count.textContent="";
    table.innerHTML='<div class="no-data">검색 결과 없음</div>';
    return;
  }
  count.textContent=`${data.length}건`;
  let h=`<table><thead><tr>
    <th data-k="ORDER">주문번호</th>
    <th data-k="MALL">쇼핑몰</th>
    <th data-k="NAME">수령인</th>
    <th data-k="INVOICE">송장번호</th>
    <th>연락처</th>
    <th data-k="PRODUCT">상품명</th>
    <th data-k="QTY">수량</th>
    <th data-k="AMOUNT">금액</th>
    <th>컬러</th>
  </tr></thead><tbody>`;
  data.forEach(r=>{
    h+=`<tr>${Object.values(COL).map(i=>`<td class="copy">${r[i]||""}</td>`).join("")}</tr>`;
  });
  table.innerHTML=h+"</tbody></table>";

  table.querySelectorAll(".copy").forEach(c=>{
    c.onclick=()=>{navigator.clipboard.writeText(c.textContent);toast();}
  });
  table.querySelectorAll("th[data-k]").forEach(th=>{
    th.onclick=()=>{
      const k=COL[th.dataset.k];
      sort.dir = sort.key===k ? -sort.dir : 1;
      sort.key=k;
      apply();
    };
  });
}

// ===== search + sort =====
function apply(){
  let d=[...rows];
  const q=search.value.toLowerCase();
  if(q) d=d.filter(r=>r.join(" ").toLowerCase().includes(q));
  if(sort.key){
    d.sort((a,b)=>{
      const A=a[sort.key],B=b[sort.key];
      return (isNaN(A)?String(A).localeCompare(B):num(A)-num(B))*sort.dir;
    });
  }
  render(d);
}

search.oninput=()=>setTimeout(apply,150);
search.onkeydown=e=>{if(e.key==="Escape"){search.value="";render([])}};
</script>
</body>
</html>

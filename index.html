<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>발주서 - Supabase</title>

<link rel="stylesheet" as="style" crossorigin
  href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css">

<style>
:root {
  --bg-gradient: radial-gradient(circle at top left, #f9a8d4 0, #e5e7eb 40%, #e0f2fe 100%);
  --card-bg: rgba(255, 255, 255, 0.96);
  --border-soft: rgba(148, 163, 184, 0.5);
  --accent: #2563eb;
  --accent-soft: rgba(37, 99, 235, 0.08);
  --text-main: #0f172a;
  --text-sub: #64748b;
}
*{box-sizing:border-box;font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
body{margin:0;min-height:100vh;padding:32px 16px;color:var(--text-main);background:var(--bg-gradient);}
.container{max-width:1200px;margin:0 auto;}
.card{background:var(--card-bg);border-radius:18px;padding:24px 24px 20px;box-shadow:0 18px 45px rgba(15,23,42,0.12),0 0 0 1px rgba(148,163,184,0.35);border:1px solid rgba(248,250,252,0.7);backdrop-filter:blur(12px);}
.card-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:18px;gap:12px;flex-wrap:wrap;}
.card-title{font-size:20px;font-weight:700;display:flex;gap:8px;align-items:center;}
.card-title-badge{font-size:11px;padding:3px 8px;border-radius:999px;background:var(--accent-soft);color:var(--accent);border:1px solid rgba(37,99,235,0.2);}
.card-subtitle{font-size:12px;color:var(--text-sub);}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0;}
.btn{border-radius:999px;border:1px solid var(--border-soft);padding:6px 14px;font-size:12px;cursor:pointer;background:#fff;}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent);}
.btn-danger{background:#ef4444;color:#fff;border-color:#ef4444;}
.btn:disabled{opacity:0.5;cursor:default;}
.status{font-size:11px;color:var(--text-sub);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin:8px 0 10px;}
.table-wrapper{max-height:420px;overflow:auto;border-radius:10px;border:1px solid rgba(148,163,184,0.4);background:rgba(248,250,252,0.9);}
table{width:100%;border-collapse:collapse;font-size:12px;}
thead{position:sticky;top:0;background:rgba(241,245,249,0.98);backdrop-filter:blur(6px);}
th,td{padding:6px 8px;border-bottom:1px solid rgba(226,232,240,0.8);vertical-align:top;}
tbody tr:nth-child(even){background:rgba(255,255,255,0.8);}
tbody tr:hover{background:rgba(219,234,254,0.7);}
.no-data{padding:14px;text-align:center;font-size:12px;color:var(--text-sub);}
.field{display:flex;flex-direction:column;gap:4px;margin-bottom:12px;}
.field input{border-radius:9px;border:1px solid var(--border-soft);padding:8px 10px;font-size:12px;outline:none;background:rgba(248,250,252,0.9);}
.field input:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(37,99,235,0.2);background:#fff;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media (max-width: 720px){ .grid{grid-template-columns:1fr;} }
.sep{height:1px;background:rgba(226,232,240,0.9);margin:14px 0;}
.small{font-size:11px;color:var(--text-sub);}
kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:11px;background:rgba(15,23,42,0.06);border:1px solid rgba(148,163,184,0.35);padding:2px 6px;border-radius:6px;}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">정보 조회 <span class="card-title-badge">Supabase DB</span></div>
        <div class="card-subtitle">엑셀 업로드 → DB 저장(중복 자동 덮어쓰기) → 빠른 검색</div>
      </div>
      <div class="small" id="authState">로그인 필요</div>
    </div>

    <!-- 로그인 -->
    <div id="authBox">
      <div class="grid">
        <div class="field">
          <input id="email" type="email" placeholder="이메일" autocomplete="email" />
        </div>
        <div class="field">
          <input id="password" type="password" placeholder="비밀번호" autocomplete="current-password" />
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" id="loginBtn">로그인</button>
        <button class="btn" id="signupBtn">회원가입</button>
      </div>
      <div class="small">※ 처음 1번만 회원가입 → 이후 로그인해서 사용</div>
      <div class="sep"></div>
    </div>

    <!-- 업로드 / 검색 -->
    <div id="appBox" style="display:none;">
      <div class="grid">
        <div class="field">
          <input id="searchInput" type="text" placeholder="주문번호, 수령인, 상품명 등 전체 검색 (서버 검색)" />
          <div class="small">팁: 검색 후 <kbd>Enter</kbd> 또는 잠시 멈추면 자동 조회</div>
        </div>
        <div class="field">
          <input id="fileInput" type="file" accept=".xlsx,.xls" />
          <div class="small">엑셀 첫 행은 머릿글(헤더)로 인식</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" id="uploadBtn">엑셀 업로드(중복 덮어쓰기)</button>
        <button class="btn" id="refreshBtn">최근 데이터 불러오기</button>
        <button class="btn" id="resetBtn">검색 초기화</button>
        <button class="btn btn-danger" id="logoutBtn">로그아웃</button>
      </div>

      <div class="status">
        <span id="loadStatus">대기 중</span>
        <span id="resultCount"></span>
      </div>

      <div class="table-wrapper" id="tableWrapper">
        <div class="no-data">로그인 후 데이터를 불러오세요.</div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>


<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

<script>
  console.log("SCRIPT LOADED");

  const sb = window.supabase.createClient(
    "https://uavgqjijapwunjhpokmg.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhdmdxamlqYXB3dW5qaHBva21nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2ODUzMTUsImV4cCI6MjA4MTI2MTMxNX0.JkQpf3RoPaDXVUNV_YrvzXs28uHtYQMwn5GZPNJzTv4"
  );

  // DOM
  const authState = document.getElementById("authState");
  const authBox = document.getElementById("authBox");
  const appBox = document.getElementById("appBox");

  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("password");
  const loginBtn = document.getElementById("loginBtn");
  const signupBtn = document.getElementById("signupBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loadStatus = document.getElementById("loadStatus");
  const fileInput = document.getElementById("fileInput");
const uploadBtn = document.getElementById("uploadBtn");


  async function refreshSessionUI() {
    const { data: { session }, error } = await sb.auth.getSession();
    if (error) console.error(error);

    if (session?.user) {
      authState.textContent = `로그인됨: ${session.user.email}`;
      authBox.style.display = "none";
      appBox.style.display = "block";
      loadStatus.textContent = "로그인 완료";
    } else {
      authState.textContent = "로그인 필요";
      authBox.style.display = "block";
      appBox.style.display = "none";
      loadStatus.textContent = "대기 중";
    }
  }

  loginBtn.addEventListener("click", async () => {
    loadStatus.textContent = "로그인 중...";
    const email = emailEl.value.trim();
    const password = passEl.value.trim();

    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) {
      console.error(error);
      alert("로그인 실패: " + error.message);
      loadStatus.textContent = "로그인 실패";
      return;
    }
    await refreshSessionUI();
  });

  signupBtn.addEventListener("click", async () => {
    loadStatus.textContent = "회원가입 중...";
    const email = emailEl.value.trim();
    const password = passEl.value.trim();

    const { error } = await sb.auth.signUp({ email, password });
    if (error) {
      console.error(error);
      alert("회원가입 실패: " + error.message);
      loadStatus.textContent = "회원가입 실패";
      return;
    }
    alert("회원가입 완료! 이제 로그인하세요.");
    loadStatus.textContent = "회원가입 완료";
  });

  logoutBtn.addEventListener("click", async () => {
    await sb.auth.signOut();
    await refreshSessionUI();
  });

  sb.auth.onAuthStateChange(() => refreshSessionUI());
  refreshSessionUI();



  // 사방넷 주문번호 헤더 후보
const SHABANG_HEADER_CANDIDATES = new Set([
  "주문번호(샤방넷)",
  "주문번호(사방넷)",
  "사방넷주문번호",
  "샤방넷주문번호",
  "사방넷 주문번호",
  "샤방넷 주문번호",
  "주문번호"
]);

function pickValue(rowObj, headerNames){
  for (const h of headerNames){
    if (rowObj[h] != null && String(rowObj[h]).trim() !== "") return rowObj[h];
  }
  return null;
}

uploadBtn.addEventListener("click", async () => {
  const file = fileInput.files?.[0];
  if (!file) {
    alert("엑셀 파일(.xlsx)을 먼저 선택해 주세요.");
    return;
  }

  uploadBtn.disabled = true;
  loadStatus.textContent = "엑셀 읽는 중...";

  try {
    // 1) 엑셀 읽기
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    const ws = wb.Sheets[wb.SheetNames[0]];

    // 첫 행을 머릿글로 해서 객체 배열 생성
    const rows = XLSX.utils.sheet_to_json(ws, { defval: "", raw: false });

    if (!rows.length) {
      loadStatus.textContent = "엑셀에 데이터가 없습니다.";
      return;
    }

    // 2) 사방넷 주문번호 컬럼 찾기
    const headers = Object.keys(rows[0] || {});
    const shabangHeader = headers.find(h => SHABANG_HEADER_CANDIDATES.has(String(h).trim()));

    if (!shabangHeader) {
      alert("엑셀 머릿글에 '주문번호(샤방넷)'(또는 유사 표기)이 있어야 합니다.");
      loadStatus.textContent = "머릿글(주문번호) 인식 실패";
      return;
    }

    // 3) DB에 넣을 형태로 매핑
    const mapped = [];
    for (const r of rows) {
      const shabang = String(r[shabangHeader] ?? "").trim();
      if (!shabang) continue;

      mapped.push({
        shabang_order_no: shabang, // UNIQUE 키
        mall: String(pickValue(r, ["쇼핑몰"]) ?? "").trim() || null,
        mall_order_no: String(pickValue(r, ["쇼핑몰 주문번호(필수)", "쇼핑몰 주문번호"]) ?? "").trim() || null,
        receiver: String(pickValue(r, ["수령인", "수취인", "받는분"]) ?? "").trim() || null,
        phone: String(pickValue(r, ["받는분연락처", "연락처", "전화번호"]) ?? "").trim() || null,
        invoice: String(pickValue(r, ["송장번호", "운송장번호"]) ?? "").trim() || null,
        product: String(pickValue(r, ["상품명", "상품"]) ?? "").trim() || null,
        qty: (() => {
          const v = pickValue(r, ["수량"]);
          const n = Number(String(v).replaceAll(",", "").trim());
          return Number.isFinite(n) ? n : null;
        })(),
        amount: (() => {
          const v = pickValue(r, ["결제금액", "금액"]);
          const n = Number(String(v).replaceAll(",", "").trim());
          return Number.isFinite(n) ? n : null;
        })(),
        color_code: String(pickValue(r, ["상품컬러코드", "컬러코드"]) ?? "").trim() || null,
        raw: r,
        updated_at: new Date().toISOString()
      });
    }

    if (!mapped.length) {
      loadStatus.textContent = "저장할 행이 없습니다(주문번호 비어있음).";
      return;
    }

    // 4) upsert(중복 자동 덮어쓰기)
    loadStatus.textContent = `DB 저장 중... (${mapped.length}행 / 중복 자동 덮어쓰기)`;

    const { error } = await sb
      .from("orders")
      .upsert(mapped, { onConflict: "shabang_order_no" });

    if (error) {
      console.error(error);
      alert("DB 저장 실패: " + error.message);
      loadStatus.textContent = "DB 저장 실패";
      return;
    }

    alert(`저장 완료! (${mapped.length}행 처리)`);
    loadStatus.textContent = `저장 완료 (${mapped.length}행)`;

  } catch (e) {
    console.error(e);
    alert("업로드 처리 중 오류가 발생했습니다. 콘솔(F12)을 확인해 주세요.");
    loadStatus.textContent = "업로드 오류";
  } finally {
    uploadBtn.disabled = false;
  }
});

</script>







</body>
</html>
